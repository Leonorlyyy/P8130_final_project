---
title: "P8130_final_project"
author: "Yuechu Hu, Leyang Rui, Yifei Yu, Jinghan Zhao"
date: "2024-12-03"
output: 
  pdf_document:
    keep_tex: true
editor_options:
  chunk_output_type: console
  fontsize: 12pt
header-includes:
  - \usepackage{setspace}
  - \doublespacing
---


```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(car)
library(leaps)
library(lmtest)
library(regressinator)
library(broom)
library(modelr)
library(pROC)
library(rsample)
library(survival)
library(dplyr)
library(tidyr)
library(ggsurvfit)
library(survminer)
set.seed(11)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%",
  warning = FALSE,
  message = FALSE
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

survival_df = read_csv("data/Project_2_data.csv") |>
  janitor::clean_names() |>
  rename(regional_node_positive = reginol_node_positive) |>
  mutate(
    race = factor(race),
    marital_status = factor(marital_status),
    t_stage = factor(t_stage),
    n_stage = factor(n_stage),
    x6th_stage = factor(x6th_stage),
    differentiate = factor(differentiate),
    grade = factor(grade),
    a_stage = factor(a_stage),
    estrogen_status = factor(estrogen_status),
    progesterone_status = factor(progesterone_status),
    status = factor(status)
  ) |>
  mutate(
    differentiate = factor(differentiate, levels = c("Well differentiated", 
                                                     "Moderately differentiated",
                                                     "Poorly differentiated",
                                                     "Undifferentiated")),
    differentiate = relevel(differentiate, ref = "Well differentiated")
  )
```

## Abstract


## Introduction

The data we used for this analysis originates from a breast cancer survival dataset collected from a prospective study. The dataset contains 14 important variables, including patients’ age, race, marital status, tumor size, cancer stages (T Stage, N Stage, and 6th Stage), estrogen and progesterone status, and regional node involvement. The dataset also records patients’ survival times in months and their final survival status (dead or alive). Our objective is to develop models that predict the risk of death among breast cancer patients using these features. Specifically, we aim to identify which variables significantly impact patients’ survival outcomes, determine (potential interactions among the variables, and assess the performance of the models across racial groups). Additionally, we will investigate fairness in the model predictions to ensure equitable accuracy between the majority race group “White” and the minority “Black”.

## Methods


This report was conducted using `survival_data`, which contains information about breast cancer patients from a prospective study. The dimension of this dataset is `r nrow(survival_df)` rows and `r ncol(survival_df)` columns. It contains five numeric variables, which are `age`, `tumor_size`, `regional_node_examined`, `regional_node_positive`, and `survival_months`, and eleven categorical variables, which are `race`, `marital_status`, `t_stage`, `n_stage`, `x6th_stage`, `differentiate`, `grade`, `a_stage`, `estrogen_status`, `progesterone_status`, and `status`. Key variables in the dataset include:

**age**: The age of the patient (in years).

**race**: The race of the patient, categorized as "Black", "Other", or "White".

**marital_status**: The marital status of the patient, categorized as "Divorced", "Married", "Separated", "Single", or "Widowed".

**t_stage**: Adjusted AJCC 6th T, categorized as "T1", "T2", "T3", or "T4".

**n_stage**: Adjusted AJCC 6th N, categorized as "N1", "N2", or "N3".

**x6th_stage**: Breast Adjusted AJCC 6th Stage, categorized as "IIA", "IIB", "IIIA", "IIIB", or "IIIC".

**differentiate**: Tumor differentiation grade, categorized as "Well differentiated", "Moderately differentiated", "Poorly differentiated", or "Undifferentiated".

**grade**: Tumor differentiation grade, categorized as "1", "2", "3", or "anaplastic; Grade IV".

**a_stage**: Categorized as "Regional" (a neoplasm that has extended) or "Distant" (a neoplasm that has spread to
parts of the body remote from).

**tumor_size**: The size of tumor (in millimeters).

**estrogen_status**: The status of the patient's estrogen, categorized as "Negative", or "Positive".

**progesterone_status**: The status of the patient's progesterone, categorized as "Negative", or "Positive".

**regional_node_examined**: The number of examined regional nodes.

**regional_node_positive**: The number of positive regional nodes.

**survival_month**: The time of a patient with breast cancer is expected to live after their diagnosis (in months).

**status**: The status of the patient, categorized as "Alive", or "Dead".


The dataset comprises a total of `r count(survival_df)` observations, with no missing values in the primary variables analyzed. Firstly, after cleaning and tidying the data, we could figure out the distributions of the data and check for potential outliers or influential points by plotting the distributions of the variables, such as histograms and box plots. We also examine the pairwise relationships between variables.




## Results

As shown in figure 1, we can find out that most patients are between 40 and 70 years old, and most of the survival time are larger than 45 months. The number of examined regional nodes for most subjects are smaller than 30, and the subjects with nearly 12 examined regional nodes are the most. It is worth noting that the distributions of both variables `regional_node_positive` and `tumor_size` are significantly skewed to the right. Over 2500 subjects only have 1 or 2 positive regional nodes, which is the most frequent number of positive regional nodes. Most of the tumor sizes are smaller than 50 mm, and we can find that the most frequent size is around 19 mm, followed by around 14 mm.

The figure 2 distributed the survival time by the status, showing that survival months are significantly higher for the Alive group compared to the Dead group. According the figure 3, from T1 to T3, as the stage changes, both the mean tumor sizes and IQR become larger. At T4 stage, the IQR of tumor sizes is much larger than others, and the mean size is smaller than the mean size at T3 stage. We notice that there are some potential outliers both ar T1 stage and T3 stage. The survival time is longer in the Regional stage, and the Alive group shows higher survival times across both stages by looking at the figure 4. In the figure 5, the Undifferentiated group has larger tumor sizes compared to the other categories, while the Well, Moderately, and Poorly differentiated groups show similar distributions with many smaller tumors and numerous high-value outliers. The figure 6 highlights the differences in tumor size distribution and trends with age between individuals who are alive and those who are deceased. While the "Alive" group shows no significant relationship between age and tumor size, the "Dead" group exhibits a pattern where larger tumors are associated with younger ages. According the figure 7, as it changes from undifferentiated to well differentiated, the negative correlation between the number of positive regional nodes and the survival months becomes weaker.


## Conclusion/Discussion


## Group members' contribution

Leyang and Jinghan focused on statistical methods, building models to extract meaningful insights. Yuechu and Yifei concentrated on data description and visualization, presenting information through clear visuals. All four of us contributed to the writing of the report, integrating our individual efforts into a cohesive final report that reflects both analytical depth and visual clarity.




## Appendix

```{r, echo=FALSE}

numeric_summary = survival_df |> 
  summarize(
    age_Mean = mean(age, na.rm = TRUE),
    age_SD = sd(age, na.rm = TRUE),
    age_Median = median(age, na.rm = TRUE),
    age_IQR = IQR(age, na.rm = TRUE),
    
    tumor_size_Mean = mean(tumor_size, na.rm = TRUE),
    tumor_size_SD = sd(tumor_size, na.rm = TRUE),
    tumor_size_Median = median(tumor_size, na.rm = TRUE),
    tumor_size_IQR = IQR(tumor_size, na.rm = TRUE),
    
    regional_node_examined_Mean = mean(regional_node_examined, na.rm = TRUE),
    regional_node_examined_SD = sd(regional_node_examined, na.rm = TRUE),
    regional_node_examined_Median = median(regional_node_examined, na.rm = TRUE),
    regional_node_examined_IQR = IQR(regional_node_examined, na.rm = TRUE),
    
    regional_node_positive_Mean = mean(regional_node_positive, na.rm = TRUE),
    regional_node_positive_SD = sd(regional_node_positive, na.rm = TRUE),
    regional_node_positive_Median = median(regional_node_positive, na.rm = TRUE),
    regional_node_positive_IQR = IQR(regional_node_positive, na.rm = TRUE),
    
    survival_months_Mean = mean(survival_months, na.rm = TRUE),
    survival_months_SD = sd(survival_months, na.rm = TRUE),
    survival_months_Median = median(survival_months, na.rm = TRUE),
    survival_months_IQR = IQR(survival_months, na.rm = TRUE)
  )

numeric_table = data.frame(
  Variable = c("Age", "Tumor Size", "Regional Nodes Examined", "Regional Nodes Positive", "Survival Months"),
  Mean = c(numeric_summary$age_Mean, numeric_summary$tumor_size_Mean, 
           numeric_summary$regional_node_examined_Mean, numeric_summary$regional_node_positive_Mean, 
           numeric_summary$survival_months_Mean),
  SD = c(numeric_summary$age_SD, numeric_summary$tumor_size_SD, 
         numeric_summary$regional_node_examined_SD, numeric_summary$regional_node_positive_SD, 
         numeric_summary$survival_months_SD),
  Median = c(numeric_summary$age_Median, numeric_summary$tumor_size_Median, 
             numeric_summary$regional_node_examined_Median, numeric_summary$regional_node_positive_Median, 
             numeric_summary$survival_months_Median),
  IQR = c(numeric_summary$age_IQR, numeric_summary$tumor_size_IQR, 
          numeric_summary$regional_node_examined_IQR, numeric_summary$regional_node_positive_IQR, 
          numeric_summary$survival_months_IQR)
)


categorical_table = survival_df |> 
  summarize(
    race_Black = sum(race == "Black", na.rm = TRUE),
    race_White = sum(race == "White", na.rm = TRUE),
    race_Other = sum(race == "Other", na.rm = TRUE),
    
    marital_status_Divorced = sum(marital_status == "Divorced", na.rm = TRUE),
    marital_status_Married = sum(marital_status == "Married", na.rm = TRUE),
    marital_status_Separated = sum(marital_status == "Separated", na.rm = TRUE),
    marital_status_Single = sum(marital_status == "Single", na.rm = TRUE),
    marital_status_Widowed = sum(marital_status == "Widowed", na.rm = TRUE),
    
    t_stage_T1 = sum(t_stage == "T1", na.rm = TRUE),
    t_stage_T2 = sum(t_stage == "T2", na.rm = TRUE),
    t_stage_T3 = sum(t_stage == "T3", na.rm = TRUE),
    t_stage_T4 = sum(t_stage == "T4", na.rm = TRUE),
    
    n_stage_N1 = sum(n_stage == "N1", na.rm = TRUE),
    n_stage_N2 = sum(n_stage == "N2", na.rm = TRUE),
    n_stage_N3 = sum(n_stage == "N3", na.rm = TRUE),
    
    x6th_stage_IIA = sum(x6th_stage == "IIA", na.rm = TRUE),
    x6th_stage_IIB = sum(x6th_stage == "IIB", na.rm = TRUE),
    x6th_stage_IIIA = sum(x6th_stage == "IIIA", na.rm = TRUE),
    x6th_stage_IIIB = sum(x6th_stage == "IIIB", na.rm = TRUE),
    x6th_stage_IIIC = sum(x6th_stage == "IIIC", na.rm = TRUE),
    
    differentiate_Well = sum(differentiate == "Well differentiated", na.rm = TRUE),
    differentiate_Moderate = sum(differentiate == "Moderately differentiated", na.rm = TRUE),
    differentiate_Poor = sum(differentiate == "Poorly differentiated", na.rm = TRUE),
    differentiate_Undifferentiated = sum(differentiate == "Undifferentiated", na.rm = TRUE),
    
    grade_1 = sum(grade == 1, na.rm = TRUE),
    grade_2 = sum(grade == 2, na.rm = TRUE),
    grade_3 = sum(grade == 3, na.rm = TRUE),
    grade_4 = sum(grade == 4, na.rm = TRUE),
    
    a_stage_Distant = sum(a_stage == "Distant", na.rm = TRUE),
    a_stage_Regional = sum(a_stage == "Regional", na.rm = TRUE),
    
    estrogen_status_Positive = sum(estrogen_status == "Positive", na.rm = TRUE),
    estrogen_status_Negative = sum(estrogen_status == "Negative", na.rm = TRUE),
    
    progesterone_status_Positive = sum(progesterone_status == "Positive", na.rm = TRUE),
    progesterone_status_Negative = sum(progesterone_status == "Negative", na.rm = TRUE),
    
    status_Alive = sum(status == "Alive", na.rm = TRUE),
    status_Dead = sum(status == "Dead", na.rm = TRUE)
  )


categorical_long = data.frame(
  Variable = c("Race Black", "Race White", "Race Other",
               "Marital Status Divorced", "Marital Status Married", "Marital Status Separated", 
               "Marital Status Single", "Marital Status Widowed",
               "T Stage T1", "T Stage T2", "T Stage T3", "T Stage T4",
               "N Stage N1", "N Stage N2", "N Stage N3",
               "6th Stage IIA", "6th Stage IIB", "6th Stage IIIA", "6th Stage IIIB", "6th Stage IIIC",
               "Differentiate Well", "Differentiate Moderate", "Differentiate Poor",
               "Differentiate Undifferentiated", "Grade 1", "Grade 2", "Grade 3", "Grade 4",
               "A Stage Distant", "A Stage Regional",
               "Estrogen Status Positive", "Estrogen Status Negative",
               "Progesterone Status Positive", "Progesterone Status Negative",
               "Status Alive", "Status Dead"),
  Count = c(
    categorical_table$race_Black, categorical_table$race_White, categorical_table$race_Other,
    categorical_table$marital_status_Divorced, categorical_table$marital_status_Married,
    categorical_table$marital_status_Separated, categorical_table$marital_status_Single, 
    categorical_table$marital_status_Widowed, 
    categorical_table$t_stage_T1, categorical_table$t_stage_T2, categorical_table$t_stage_T3, 
    categorical_table$t_stage_T4, categorical_table$n_stage_N1, categorical_table$n_stage_N2, 
    categorical_table$n_stage_N3, categorical_table$x6th_stage_IIA, categorical_table$x6th_stage_IIB, 
    categorical_table$x6th_stage_IIIA, categorical_table$x6th_stage_IIIB, categorical_table$x6th_stage_IIIC, 
    categorical_table$differentiate_Well, categorical_table$differentiate_Moderate, 
    categorical_table$differentiate_Poor, categorical_table$differentiate_Undifferentiated, 
    categorical_table$grade_1, categorical_table$grade_2, categorical_table$grade_3, categorical_table$grade_4,
    categorical_table$a_stage_Distant, categorical_table$a_stage_Regional,
    categorical_table$estrogen_status_Positive, categorical_table$estrogen_status_Negative,
    categorical_table$progesterone_status_Positive, categorical_table$progesterone_status_Negative,
    categorical_table$status_Alive, categorical_table$status_Dead
  ),
  Proportion = round(c(
    categorical_table$race_Black / nrow(survival_df), categorical_table$race_White / nrow(survival_df),
    categorical_table$race_Other / nrow(survival_df), categorical_table$marital_status_Divorced / nrow(survival_df),
    categorical_table$marital_status_Married / nrow(survival_df), categorical_table$marital_status_Separated / nrow(survival_df),
    categorical_table$marital_status_Single / nrow(survival_df), categorical_table$marital_status_Widowed / nrow(survival_df),
    categorical_table$t_stage_T1 / nrow(survival_df), categorical_table$t_stage_T2 / nrow(survival_df),
    categorical_table$t_stage_T3 / nrow(survival_df), categorical_table$t_stage_T4 / nrow(survival_df),
    categorical_table$n_stage_N1 / nrow(survival_df), categorical_table$n_stage_N2 / nrow(survival_df),
    categorical_table$n_stage_N3 / nrow(survival_df), categorical_table$x6th_stage_IIA / nrow(survival_df),
    categorical_table$x6th_stage_IIB / nrow(survival_df), categorical_table$x6th_stage_IIIA / nrow(survival_df),
    categorical_table$x6th_stage_IIIB / nrow(survival_df), categorical_table$x6th_stage_IIIC / nrow(survival_df),
    categorical_table$differentiate_Well / nrow(survival_df), categorical_table$differentiate_Moderate / nrow(survival_df),
    categorical_table$differentiate_Poor / nrow(survival_df), categorical_table$differentiate_Undifferentiated / nrow(survival_df),
    categorical_table$grade_1 / nrow(survival_df), categorical_table$grade_2 / nrow(survival_df),
    categorical_table$grade_3 / nrow(survival_df), categorical_table$grade_4 / nrow(survival_df),
    categorical_table$a_stage_Distant / nrow(survival_df), categorical_table$a_stage_Regional / nrow(survival_df),
    categorical_table$estrogen_status_Positive / nrow(survival_df), categorical_table$estrogen_status_Negative / nrow(survival_df),
    categorical_table$progesterone_status_Positive / nrow(survival_df), categorical_table$progesterone_status_Negative / nrow(survival_df),
    categorical_table$status_Alive / nrow(survival_df), categorical_table$status_Dead / nrow(survival_df)
  ), 4)
)

categorical_long = categorical_long |> 
  separate(Variable, into = c("Variable Name", "Level"), sep = " (?=Black|White|Other|Divorced|Married|Separated|Single|Widowed|T1|T2|T3|T4|N1|N2|N3|IIA|IIB|IIIA|IIIB|IIIC|Well|Moderate|Poor|Undifferentiated|1|2|3|4|Distant|Regional|Positive|Negative|Alive|Dead)")
```

```{r, echo=FALSE}
knitr::kable(numeric_table, col.names = c("Variable Name", "Mean", "SD", "Median", "IQR"), 
             caption = "Summary Statistics for Numeric Variables", format = "pipe")
```

```{r, echo=FALSE}
knitr::kable(categorical_long, col.names = c("Variable Name", "Level", "Count", "Proportion"), 
             caption = "Summary Statistics for Categorical Variables", format = "pipe")

```



```{r distribution_of_the_continuous_variables, echo=FALSE, fig.cap="Distribution of the Continuous Variables"}
survival_df |> 
  pivot_longer(
    cols = c(age, tumor_size, regional_node_examined, regional_node_positive, survival_months),
    names_to = "variable",
    values_to = "value"
  ) |>
  ggplot(aes(x = value)) +
  geom_histogram(color = "light blue") +
  facet_wrap(variable ~ .,  scales = "free") +
    labs(title = "Distribution of the Continuous Variables",
         x = "Variables",
         y = "Frequency")
```



```{r survival_months_by_status, echo=FALSE, fig.cap="Survival Months by Status"}
ggplot(survival_df, aes(x = status, y = survival_months)) + 
  geom_boxplot(fill = "light blue") +
  labs(title = "Boxplot of Survival Months by Status", x = "Status", y = "Survival Months") +
  theme_minimal()
```



```{r tumor_sizes_by_t_stage, echo=FALSE, fig.cap="Tumor Sizes by T stage"}
ggplot(survival_df, aes(x = tumor_size, y = t_stage)) +
  geom_boxplot(fill = "light blue") +
  scale_x_continuous(breaks = seq(0, max(survival_df$tumor_size, na.rm = TRUE), by = 10)) +
  labs(
    title = "Distribution of Tumor Sizes by T_stage",
    x = "Tumor Sizes",
    y = "T_stage"
  )
```




```{r survival_months_by_a_stage_based_on_status, echo=FALSE, fig.cap="Survival Months by A stage Based on Status"}
ggplot(survival_df, aes(x = survival_months, y = a_stage)) +
  geom_boxplot(fill = "light blue") +
  scale_x_continuous(breaks = seq(0, max(survival_df$survival_months, na.rm = TRUE), by = 10)) +
  labs(
    title = "Distribution of Survival Months by A_stage",
    x = "Survival Months",
    y = "A_stage"
  ) +
  facet_grid(~ status)
```



```{r tumor_size_by_differentiate, echo=FALSE, fig.cap="Tumor Size by Differentiate"}
ggplot(survival_df, aes(x = differentiate, y = tumor_size)) +
  geom_boxplot(fill = "lightblue") +
  labs(title = "Tumor Size Distribution by Differentiate",
       x = "Differentiate",
       y = "Tumor Size (mm)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```




```{r relationship_between_age_and_tumor_size_across_status, echo=FALSE, fig.cap="Relationship Between Age and Tumor Size across Status"}
ggplot(survival_df, aes(x = age, y = tumor_size, color = status)) +
    geom_point(alpha = 0.5, size = 0.6) +
  geom_smooth(method = "lm", color = "green") +
  facet_wrap(~ status) +
    labs(title = "Relationship Between Age and Tumor Size",
         x = "Age (years)",
         y = "Tumor Size (mm)",
         color = "Status") +
    theme_minimal()

```




```{r positive_regional_node_vs_survival_months_across_differentiate, echo=FALSE, fig.cap="Positive Regional Node vs Survival Months Across Differentiate"}
ggplot(survival_df, aes(x = regional_node_positive, y = survival_months)) +
  geom_point(color = "light blue", size = 0.5, alpha = 0.5)  +
  facet_wrap(.~differentiate) +
  geom_smooth(method = "lm") +
  labs(
    title = "Distribution of Positive Regional Node and Survival Months by Differentiate",
    x = "Positive Regional Node",
    y = "Survival Months"
  ) +
  theme_minimal()
```











